# Mini DOAMP - Codex 审核指南

> 本文件是代码审核标准。每个 Phase 完成后，可将代码提交给 Codex 按本文件进行审查。

## 1. 审核者角色

你是代码审核者。本项目由 Claude Code CLI 编写，你的职责是：
- 审核代码质量、架构设计和安全性
- **严格对照简历原文**，确保代码实现能支撑面试时的每一句话
- 像一个苛刻的面试官一样逐字核对

## 2. 审核输出格式

每次审核请按以下格式输出：
- ✅ 符合简历描述的实现
- ⚠️ 实现了但有改进空间
- ❌ 和简历描述不符或有严重问题
- 给出具体修改建议和代码位置

## 3. 简历原文（审核唯一基准）

### 第1条：预警引擎
主导预警系统架构重构，针对原有预警与事件表强耦合、新增指标需改动多处代码的痛点，将其重构为基于"指标主表 + 阈值子表"的独立预警引擎。通过策略模式按指标类型（运行类、运营类、银行类、渠道效能类、自定义SQL类等7种）路由不同查询与判定逻辑，支持动态扩展。

### 第2条：消息推送
设计并实现预警消息异步推送架构，引入RabbitMQ按预警方式（短信/邮件/企业微信）通过Topic Exchange动态路由至三个消费队列，基于消息唯一ID实现幂等消费防止重复发送；通过死信队列+定时任务补偿机制处理发送失败的消息自动重试（最多3次，超限人工告警）。

### 第3条：Redis缓存
基于Redis缓存字典翻译数据和高频指标查询结果，采用Cache Aside模式保证缓存一致性，结合延迟双删策略处理数据更新场景；对热点指标数据设置随机过期时间防止缓存雪崩，对空值设置短TTL缓存防止缓存穿透。

### 第4条：定时调度
基于XXL-Job+ShedLock实现分布式定时调度，排查并解决了不同任务模板在同一调度周期触发时因锁名称相同导致任务被误跳过的线上问题，通过动态生成锁名称（任务类型+模板ID）实现细粒度锁控制。

### 第5条：多库适配
负责多数据库适配改造，设计数据库Adapter抽象层，基于MyBatis的databaseIdProvider机制自动识别数据库类型，通过适配器工厂模式将日期函数、分页语法、字符串聚合等方言差异封装为统一接口。

### 第6条：慢查询优化（口述项，不审查代码）
针对驾驶舱和大屏的慢查询进行专项优化，通过EXPLAIN分析定位函数调用导致索引失效问题，添加覆盖索引和联合索引，核心报表查询从3s+降至200ms以内。

### 第7条：SOP工作流
参与SOP工作流引擎开发，基于状态机模式实现任务全生命周期管理（创建→分配→执行→审批→完成/回退/终止），通过审批节点支持通过/驳回/回退操作，支持任务退回至任意已完成节点；每次状态变更写入操作流水表实现全链路可追溯。

### 第8条：gRPC通信（口述项，不审查代码）
参与微服务间gRPC通信开发，基于Proto文件定义服务契约，配置TLS双向证书认证与Zookeeper服务注册发现。

## 4. 分模块审查清单

### Phase 1：预警引擎审查
- [ ] 是否使用策略模式（WarnStrategy接口 + 7个实现类），而非 if-else
- [ ] 7种指标类型是否全部实现，查询逻辑是否各不相同
- [ ] 自定义SQL类型是否做了SQL注入防护（白名单/参数化）
- [ ] 指标主表 + 阈值子表是否独立设计，而非和事件表耦合
- [ ] WarnEngine 是否通过指标类型路由到对应策略
- [ ] 新增指标类型时是否只需新增策略类，无需改动引擎代码

### Phase 2：消息推送审查
- [ ] 是否使用 Topic Exchange（不是 Direct 或 Fanout）
- [ ] 是否有 3 个独立消费队列（sms/email/wxwork）
- [ ] 幂等消费是否基于消息唯一ID + Redis SET 实现
- [ ] 死信队列是否正确配置（DLX + DLQ）
- [ ] 重试机制是否最多 3 次，超限是否标记为"告警"状态
- [ ] 消息流水表是否记录完整状态流转（待发送→已发送→失败→已重试→告警）
- [ ] 实际发送是否为 Mock（只打日志），不调第三方

### Phase 3：Redis 缓存审查
- [ ] Cache Aside 模式是否正确（读：缓存→DB→回填；写：更新DB→删缓存）
- [ ] 延迟双删是否实现（删缓存→更新DB→延迟500ms→再删）
- [ ] 热点数据 TTL 是否有随机偏移（防雪崩）
- [ ] 空值是否缓存并设置短 TTL（防穿透）
- [ ] 是否提供手动刷新缓存的 REST 接口
- [ ] 缓存 key 命名是否规范，是否有前缀区分

### Phase 4：定时调度审查
- [ ] 是否集成 XXL-Job（不是 @Scheduled）
- [ ] ShedLock 锁名称是否动态生成，预警用 `warn_check_${ruleId}`，SOP用 `sop_generate_${templateId}`
- [ ] 不同任务模板在同一调度周期是否能并行执行（不互相抢锁）
- [ ] 定时任务是否包含：预警检查 + SOP任务生成

### Phase 5：SOP 工作流审查
- [ ] 是否使用状态机模式（枚举状态 + 转换矩阵），而非硬编码状态判断
- [ ] 状态流转是否完整：创建→待分配→执行中→审批中→已完成/已驳回/已终止（回退后任务回到执行中，TaskExec 标记 ROLLED_BACK）
- [ ] WorkflowEngine.advance() 是否存在且逻辑正确
- [ ] 不同节点类型是否用策略模式处理（处理/审批/抄送各有不同逻辑）
- [ ] 是否支持回退到任意已完成节点
- [ ] 回退时中间节点的执行记录是否标记为 ROLLED_BACK（不物理删除）
- [ ] 每次状态变更是否写入操作流水表（操作人、时间、类型、备注）
- [ ] 状态变更后是否触发消息通知（复用模块二的 RabbitMQ）
- [ ] 前端流程设计器是否使用 AntV X6
- [ ] 流程查看器是否能高亮当前所在节点

### Phase 6：多库适配审查
- [ ] 是否使用 MyBatis databaseIdProvider 自动识别数据库类型
- [ ] 是否设计了 DatabaseAdapter 抽象接口
- [ ] 是否使用适配器工厂模式获取对应实现
- [ ] 是否至少有 2-3 个方言差异示例（日期函数、分页语法等）
- [ ] MySQL 和 H2 两种数据库是否都能正常切换运行

### Phase 7：前端审查
- [ ] 组件是否使用 PascalCase 命名
- [ ] API 文件是否按模块组织
- [ ] 是否使用 Vuex 管理全局状态（用户信息、权限）
- [ ] Axios 是否统一封装了请求/响应拦截器（含 JWT token 注入、403 处理）
- [ ] 流程设计器是否基于 AntV X6（不是其他库）
- [ ] 流程查看器是否为 X6 只读模式 + 高亮当前节点

## 5. 安全审查清单（每个 Phase 都需检查）

- [ ] 自定义 SQL 预警类型是否做了注入防护（白名单关键字 + 禁止 DROP/DELETE/UPDATE）
- [ ] JWT 是否正确实现（签名算法、过期时间、刷新机制）
- [ ] 接口是否有权限校验（不能未登录访问业务接口）
- [ ] 敏感数据是否脱敏（密码不明文存储、日志不打印密码）
- [ ] 前端是否防 XSS（用户输入不直接 v-html 渲染）
- [ ] Redis 操作是否有竞态条件风险

## 6. 审查触发时机

| 时机 | 审查范围 | 重点 |
|------|---------|------|
| Phase 0 完成 | 项目骨架 + 建表SQL | 表结构是否合理、模块拆分是否正确 |
| Phase 1 完成 | 预警引擎代码 | 策略模式、7种类型、SQL注入防护 |
| Phase 2 完成 | 消息推送代码 | MQ配置、幂等、死信队列、重试机制 |
| Phase 3 完成 | Redis缓存代码 | 四种缓存策略是否全部体现 |
| Phase 4 完成 | 定时调度代码 | ShedLock动态锁名、XXL-Job集成 |
| Phase 5 完成 | SOP工作流代码 | 状态机、回退机制、操作流水、流程设计器 |
| Phase 6 完成 | 多库适配代码 | Adapter工厂、databaseIdProvider |
| Phase 7 完成 | 前端代码 | 组件规范、X6集成、状态管理 |
| 全部完成 | 整体项目 | 简历8条逐条核对、端到端可运行 |
